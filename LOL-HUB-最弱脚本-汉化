-- LOL漢化Hub - 完整功能整合版 (LinoriaLib)

-- 繞過反作弊系統
local function BypassAntiCheat()
    local SafeEnv = {}
    setmetatable(SafeEnv, {__index = getgenv()})
    
    SafeEnv.hookfunction = nil
    SafeEnv.getconnections = nil
    SafeEnv.getrawmetatable = nil
    
    local originalNamecall
    originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local method = getnamecallmethod()
        if method == "Kick" or method == "kick" then
            return nil
        end
        return originalNamecall(self, ...)
    end)
    
    local originalIndex
    originalIndex = hookmetamethod(game, "__index", function(self, key)
        if key == "Parent" and self == game then
            return game
        end
        return originalIndex(self, key)
    end)
    
    return SafeEnv
end

local SafeEnvironment = BypassAntiCheat()

-- 加載LinoriaLib
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/Library.lua"))()
local ThemeManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/addons/SaveManager.lua"))()

-- 創建主視窗
local Window = Library:CreateWindow({
    Title = "LOL漢化Hub - 完整整合版",
    Footer = "LOL漢化組 | 全功能版本",
    Center = true,
    AutoShow = true,
    Resizable = true,
    ShowCustomCursor = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

-- 創建標籤頁
local Tabs = {
    Scripts = Window:AddTab("腳本中心", "code"),
    Visuals = Window:AddTab("視覺效果", "eye"),
    Player = Window:AddTab("玩家功能", "user"),
    Combat = Window:AddTab("戰鬥功能", "sword"),
    Aiming = Window:AddTab("自瞄功能", "target"),
    Hitbox = Window:AddTab("碰撞箱擴展", "box"),
    Dodge = Window:AddTab("完美閃避", "shield"),
    Misc = Window:AddTab("雜項功能", "settings"),
    Settings = Window:AddTab("UI設定", "sliders-horizontal")
}

-- 初始化設定管理
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
ThemeManager:SetFolder("LOLHanhuaHub")
SaveManager:SetFolder("LOLHanhuaHub/settings")

-- 腳本中心功能
local ScriptsGroup = Tabs.Scripts:AddLeftGroupbox("遊戲腳本", "gamepad") do
    ScriptsGroup:AddButton("Fartsaken被遺棄", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/Fartsaken-LOL-QQ737561425"))()
        Library:Notify("Fartsaken腳本已加載", 3)
    end)

    ScriptsGroup:AddButton("BronxWare 99 Nights漢化", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/BronxWare99Nights-LOL"))()
        Library:Notify("BronxWare腳本已加載", 3)
    end)

    ScriptsGroup:AddButton("Doors XA Hub", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/DoorsXAHubLOL"))()
        Library:Notify("Doors XA Hub腳本已加載", 3)
    end)

    ScriptsGroup:AddButton("住宅大屠殺", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/LOLHANHUA"))()
        Library:Notify("住宅大屠殺腳本已加載", 3)
    end)

    ScriptsGroup:AddButton("Red Hub(死亡之死LOL漢化)", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/Death%20is%20die"))()
        Library:Notify("Red Hub腳本已加載", 3)
    end)

    ScriptsGroup:AddButton("UNDETECTEDWARE犯罪(半漢化)", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/UNDETECTEDWARE-LOLHAZNHUA"))()
        Library:Notify("UNDETECTEDWARE腳本已加載", 3)
    end)
end

local ToolsGroup = Tabs.Scripts:AddRightGroupbox("工具腳本", "wrench") do
    ToolsGroup:AddButton("飛行腳本", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/漢化飛行"))()
        Library:Notify("飛行功能已啟用", 3)
    end)

    ToolsGroup:AddButton("甩人腳本", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/甩人漢化"))()
        Library:Notify("甩人功能已啟用", 3)
    end)

    ToolsGroup:AddButton("時間回溯", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/回溯時間LOL"))()
        Library:Notify("時間回溯功能已啟用", 3)
    end)

    ToolsGroup:AddButton("無敵少俠飛行r15", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/useert741/-X---byLOL/refs/heads/main/invincible-FLY"))()
        Library:Notify("無敵少俠飛行已啟用", 3)
    end)

    ToolsGroup:AddButton("甩飛腳本", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/0Ben1/fe./main/Fling%20GUI"))()
        Library:Notify("甩飛腳本已加載", 3)
    end)
end

-- 完美閃避功能
local perfectDodgeEnabled = false
local dodgeConnection = nil
local isDodging = false
local lastDodgeTime = 0

local DodgeMainGroup = Tabs.Dodge:AddLeftGroupbox("完美閃避", "shield") do
    DodgeMainGroup:AddToggle("PerfectDodge", {
        Text = "啟用完美閃避",
        Default = false,
        Callback = function(value)
            perfectDodgeEnabled = value
            if value then
                startDodgeSystem()
                Library:Notify("完美閃避已啟用", 3)
            else
                stopDodgeSystem()
                Library:Notify("完美閃避已禁用", 3)
            end
        end
    })

    DodgeMainGroup:AddSlider("DodgeDistance", {
        Text = "閃避距離",
        Default = 10,
        Min = 5,
        Max = 30,
        Rounding = 1
    })

    DodgeMainGroup:AddSlider("DodgeCooldown", {
        Text = "閃避冷卻",
        Default = 1,
        Min = 0.5,
        Max = 5,
        Rounding = 1
    })

    DodgeMainGroup:AddSlider("DetectionRange", {
        Text = "檢測範圍",
        Default = 15,
        Min = 5,
        Max = 50,
        Rounding = 1
    })
end

local DodgeSettingsGroup = Tabs.Dodge:AddRightGroupbox("閃避設定", "settings") do
    DodgeSettingsGroup:AddToggle("DodgeProjectiles", {
        Text = "閃避遠程攻擊",
        Default = true
    })

    DodgeSettingsGroup:AddToggle("DodgeMelee", {
        Text = "閃避近戰攻擊",
        Default = true
    })

    DodgeSettingsGroup:AddToggle("DodgeInvincible", {
        Text = "閃避後無敵1秒",
        Default = true
    })

    DodgeSettingsGroup:AddToggle("DodgeVisual", {
        Text = "閃避視覺效果",
        Default = true
    })

    DodgeSettingsGroup:AddDropdown("DodgePriority", {
        Text = "閃避優先級",
        Values = {"安全方向", "隨機方向", "遠離攻擊源"},
        Default = "安全方向"
    })
end

-- 閃避系統
function startDodgeSystem()
    dodgeConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not perfectDodgeEnabled or isDodging then return end
        
        local player = game.Players.LocalPlayer
        local character = player.Character
        if not character then return end
        
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then return end
        
        -- 檢查冷卻
        if tick() - lastDodgeTime < (Options.DodgeCooldown and Options.DodgeCooldown.Value or 1) then
            return
        end
        
        -- 檢測攻擊
        local shouldDodge, attackPosition, attackType = detectIncomingAttack(character, humanoidRootPart)
        
        if shouldDodge then
            performDodge(character, humanoidRootPart, attackPosition, attackType)
        end
    end)
end

function stopDodgeSystem()
    if dodgeConnection then
        dodgeConnection:Disconnect()
        dodgeConnection = nil
    end
end

function detectIncomingAttack(character, rootPart)
    local detectionRange = Options.DetectionRange and Options.DetectionRange.Value or 15
    local checkProjectiles = Options.DodgeProjectiles and Options.DodgeProjectiles.Value or true
    local checkMelee = Options.DodgeMelee and Options.DodgeMelee.Value or true
    
    -- 檢測遠程攻擊（飛行的物體）
    if checkProjectiles then
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") and obj.Velocity.Magnitude > 10 then
                local distance = (rootPart.Position - obj.Position).Magnitude
                if distance <= detectionRange then
                    -- 檢查是否朝向玩家飛來
                    local directionToPlayer = (rootPart.Position - obj.Position).Unit
                    local dotProduct = obj.Velocity.Unit:Dot(directionToPlayer)
                    if dotProduct > 0.7 then -- 大致朝向玩家
                        return true, obj.Position, "projectile"
                    end
                end
            end
        end
    end
    
    -- 檢測近戰攻擊（附近的玩家）
    if checkMelee then
        for _, otherPlayer in pairs(game.Players:GetPlayers()) do
            if otherPlayer ~= game.Players.LocalPlayer and otherPlayer.Character then
                local otherCharacter = otherPlayer.Character
                local otherRoot = otherCharacter:FindFirstChild("HumanoidRootPart")
                local tool = otherCharacter:FindFirstChildOfClass("Tool")
                
                if otherRoot then
                    local distance = (rootPart.Position - otherRoot.Position).Magnitude
                    if distance <= detectionRange then
                        -- 檢查是否在攻擊動畫或持有武器
                        if tool or isPlayerAttacking(otherCharacter) then
                            return true, otherRoot.Position, "melee"
                        end
                    end
                end
            end
        end
    end
    
    -- 檢測射線攻擊
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {character}
    
    local directions = {
        Vector3.new(1, 0, 0),   -- 右
        Vector3.new(-1, 0, 0),  -- 左
        Vector3.new(0, 1, 0),   -- 上
        Vector3.new(0, -1, 0),  -- 下
        Vector3.new(0, 0, 1),   -- 前
        Vector3.new(0, 0, -1)   -- 後
    }
    
    for _, direction in pairs(directions) do
        local rayOrigin = rootPart.Position
        local rayDirection = direction * detectionRange
        local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
        
        if raycastResult then
            local hit = raycastResult.Instance
            -- 檢查是否為攻擊性物體
            if hit and (hit.Name:lower():find("bullet") or hit.Name:lower():find("projectile") or hit.Name:lower():find("attack")) then
                return true, raycastResult.Position, "raycast"
            end
        end
    end
    
    return false, nil, nil
end

function isPlayerAttacking(character)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        -- 檢查是否在攻擊動畫狀態
        local tool = character:FindFirstChildOfClass("Tool")
        if tool then
            return true
        end
    end
    return false
end

function performDodge(character, rootPart, attackPosition, attackType)
    if isDodging then return end
    
    isDodging = true
    lastDodgeTime = tick()
    
    local dodgeDistance = Options.DodgeDistance and Options.DodgeDistance.Value or 10
    local priority = Options.DodgePriority and Options.DodgePriority.Value or "安全方向"
    
    -- 計算閃避方向
    local dodgeDirection = calculateDodgeDirection(rootPart, attackPosition, priority, dodgeDistance)
    
    -- 執行閃避傳送
    local newPosition = rootPart.Position + dodgeDirection * dodgeDistance
    
    -- 確保新位置安全（不在牆內）
    local safePosition = findSafePosition(newPosition, character)
    
    -- 傳送到安全位置
    rootPart.CFrame = CFrame.new(safePosition)
    
    -- 閃避視覺效果
    if Options.DodgeVisual and Options.DodgeVisual.Value then
        createDodgeEffect(character, safePosition)
    end
    
    -- 無敵效果
    if Options.DodgeInvincible and Options.DodgeInvincible.Value then
        applyInvincibility(character)
    end
    
    Library:Notify("完美閃避！", 2)
    
    -- 重置閃避狀態
    wait(0.1)
    isDodging = false
end

function calculateDodgeDirection(rootPart, attackPosition, priority, distance)
    local directions = {
        ["前"] = rootPart.CFrame.LookVector * distance,
        ["後"] = -rootPart.CFrame.LookVector * distance,
        ["左"] = -rootPart.CFrame.RightVector * distance,
        ["右"] = rootPart.CFrame.RightVector * distance,
        ["上"] = Vector3.new(0, distance, 0),
        ["下"] = Vector3.new(0, -distance, 0)
    }
    
    if priority == "隨機方向" then
        local directionKeys = {"前", "後", "左", "右", "上", "下"}
        local randomKey = directionKeys[math.random(1, #directionKeys)]
        return directions[randomKey]
        
    elseif priority == "遠離攻擊源" and attackPosition then
        local awayFromAttack = (rootPart.Position - attackPosition).Unit * distance
        return awayFromAttack
        
    else -- 安全方向（默認）
        -- 檢查每個方向的安全性
        local safeDirections = {}
        
        for directionName, directionVector in pairs(directions) do
            if isDirectionSafe(rootPart.Position, directionVector) then
                table.insert(safeDirections, directionVector)
            end
        end
        
        if #safeDirections > 0 then
            return safeDirections[math.random(1, #safeDirections)]
        else
            -- 如果沒有安全方向，隨機選擇
            local directionKeys = {"前", "後", "左", "右"}
            local randomKey = directionKeys[math.random(1, #directionKeys)]
            return directions[randomKey]
        end
    end
end

function isDirectionSafe(startPosition, direction)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {game.Players.LocalPlayer.Character}
    
    local raycastResult = workspace:Raycast(startPosition, direction, raycastParams)
    
    -- 如果射線沒有碰到任何東西，或者碰到的東西距離足夠遠，則認為安全
    if not raycastResult then
        return true
    end
    
    local hitDistance = (raycastResult.Position - startPosition).Magnitude
    return hitDistance > 5 -- 至少5單位距離才安全
end

function findSafePosition(targetPosition, character)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {character}
    
    -- 從目標位置向上檢測，找到地面
    local upRay = workspace:Raycast(targetPosition + Vector3.new(0, 50, 0), Vector3.new(0, -100, 0), raycastParams)
    if upRay then
        return upRay.Position + Vector3.new(0, 3, 0) -- 在地面上方3單位
    end
    
    return targetPosition -- 如果找不到地面，返回原始位置
end

function createDodgeEffect(character, position)
    -- 創建閃避特效
    local effect = Instance.new("Part")
    effect.Size = Vector3.new(5, 5, 5)
    effect.Position = position
    effect.Anchored = true
    effect.CanCollide = false
    effect.Material = Enum.Material.Neon
    effect.BrickColor = BrickColor.new("Bright blue")
    effect.Transparency = 0.3
    
    local highlight = Instance.new("Highlight")
    highlight.FillColor = Color3.fromRGB(0, 150, 255)
    highlight.OutlineColor = Color3.fromRGB(0, 100, 200)
    highlight.FillTransparency = 0.5
    highlight.Parent = effect
    
    effect.Parent = workspace
    
    -- 3秒後消失
    game:GetService("Debris"):AddItem(effect, 3)
end

function applyInvincibility(character)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    -- 保存原始屬性
    local originalHealth = humanoid.Health
    local originalMaxHealth = humanoid.MaxHealth
    
    -- 設置無敵
    humanoid.MaxHealth = math.huge
    humanoid.Health = math.huge
    
    -- 添加視覺效果
    local forceField = Instance.new("ForceField")
    forceField.Visible = true
    forceField.Parent = character
    
    local highlight = Instance.new("Highlight")
    highlight.FillColor = Color3.fromRGB(0, 255, 0)
    highlight.OutlineColor = Color3.fromRGB(0, 200, 0)
    highlight.FillTransparency = 0.3
    highlight.Parent = character
    
    -- 1秒後恢復
    wait(1)
    
    -- 移除視覺效果
    forceField:Destroy()
    highlight:Destroy()
    
    -- 恢復原始生命值
    humanoid.MaxHealth = originalMaxHealth
    humanoid.Health = math.min(originalHealth, originalMaxHealth)
end

-- 簡化的碰撞箱擴展功能
local hitboxEnabled = false
local originalSizes = {}

local HitboxGroup = Tabs.Hitbox:AddLeftGroupbox("碰撞箱擴展", "box") do
    HitboxGroup:AddToggle("HitboxToggle", {
        Text = "啟用碰撞箱擴展",
        Default = false,
        Callback = function(value)
            hitboxEnabled = value
            if value then
                expandHitboxes()
                Library:Notify("碰撞箱擴展已啟用", 3)
            else
                restoreHitboxes()
                Library:Notify("碰撞箱擴展已禁用", 3)
            end
        end
    })

    HitboxGroup:AddSlider("HitboxSize", {
        Text = "碰撞箱大小",
        Default = 10,
        Min = 5,
        Max = 50,
        Rounding = 1,
        Callback = function(value)
            if hitboxEnabled then
                expandHitboxes()
            end
        end
    })

    HitboxGroup:AddToggle("HitboxTeamCheck", {
        Text = "忽略隊友",
        Default = true
    })

    HitboxGroup:AddToggle("HitboxVisible", {
        Text = "顯示碰撞箱",
        Default = true
    })
end

function expandHitboxes()
    local players = game:GetService("Players"):GetPlayers()
    local localPlayer = game:GetService("Players").LocalPlayer
    local hitboxSize = Options.HitboxSize and Options.HitboxSize.Value or 10
    local ignoreTeam = Options.HitboxTeamCheck and Options.HitboxTeamCheck.Value or true
    
    for _, player in pairs(players) do
        if player ~= localPlayer then
            local character = player.Character
            if character then
                -- 檢查隊伍
                if ignoreTeam and player.Team == localPlayer.Team then
                    continue
                end
                
                -- 擴展主要身體部位
                local parts = {
                    "Head",
                    "HumanoidRootPart", 
                    "Torso",
                    "UpperTorso",
                    "LowerTorso"
                }
                
                for _, partName in pairs(parts) do
                    local part = character:FindFirstChild(partName)
                    if part and part:IsA("BasePart") then
                        -- 保存原始大小
                        if not originalSizes[player] then
                            originalSizes[player] = {}
                        end
                        if not originalSizes[player][partName] then
                            originalSizes[player][partName] = part.Size
                        end
                        
                        -- 設置新大小
                        part.Size = Vector3.new(hitboxSize, hitboxSize, hitboxSize)
                        
                        -- 設置透明度
                        if Options.HitboxVisible and Options.HitboxVisible.Value then
                            part.Transparency = 0.5
                            part.Material = Enum.Material.Neon
                            part.BrickColor = BrickColor.new("Bright red")
                        else
                            part.Transparency = 1
                        end
                    end
                end
            end
        end
    end
end

function restoreHitboxes()
    for player, parts in pairs(originalSizes) do
        if player and player.Character then
            for partName, originalSize in pairs(parts) do
                local part = player.Character:FindFirstChild(partName)
                if part and part:IsA("BasePart") then
                    part.Size = originalSize
                    part.Transparency = 0
                    part.Material = Enum.Material.Plastic
                end
            end
        end
    end
    originalSizes = {}
end

-- 視覺效果功能
local lighting = game:GetService("Lighting")

local LightingGroup = Tabs.Visuals:AddLeftGroupbox("光照效果", "sun") do
    LightingGroup:AddSlider("ExposureSlider", {
        Text = "曝光度",
        Default = 1,
        Min = 0,
        Max = 10,
        Rounding = 1,
        Callback = function(value)
            lighting.ExposureCompensation = value - 1
        end
    })

    LightingGroup:AddSlider("BrightnessSlider", {
        Text = "亮度",
        Default = 1,
        Min = 0,
        Max = 2,
        Rounding = 1,
        Callback = function(value)
            if not lighting:FindFirstChild("ColorCorrection_Brightness") then
                local cc = Instance.new("ColorCorrectionEffect")
                cc.Name = "ColorCorrection_Brightness"
                cc.Parent = lighting
            end
            lighting.ColorCorrection_Brightness.Brightness = (value - 1) * 0.3
        end
    })

    LightingGroup:AddSlider("ContrastSlider", {
        Text = "對比度",
        Default = 1,
        Min = 0,
        Max = 2,
        Rounding = 1,
        Callback = function(value)
            if not lighting:FindFirstChild("ColorCorrection_Contrast") then
                local cc = Instance.new("ColorCorrectionEffect")
                cc.Name = "ColorCorrection_Contrast"
                cc.Parent = lighting
            end
            lighting.ColorCorrection_Contrast.Contrast = (value - 1) * 0.5
        end
    })

    LightingGroup:AddSlider("SaturationSlider", {
        Text = "飽和度",
        Default = 1,
        Min = 0,
        Max = 2,
        Rounding = 1,
        Callback = function(value)
            if not lighting:FindFirstChild("ColorCorrection_Saturation") then
                local cc = Instance.new("ColorCorrectionEffect")
                cc.Name = "ColorCorrection_Saturation"
                cc.Parent = lighting
            end
            lighting.ColorCorrection_Saturation.Saturation = value - 1
        end
    })
end

local PostProcessGroup = Tabs.Visuals:AddRightGroupbox("後處理效果", "sliders") do
    PostProcessGroup:AddSlider("BloomSlider", {
        Text = "高光強度",
        Default = 1,
        Min = 0,
        Max = 2,
        Rounding = 1,
        Callback = function(value)
            if not lighting:FindFirstChild("BloomEffect") then
                local bloom = Instance.new("BloomEffect")
                bloom.Parent = lighting
            end
            lighting.BloomEffect.Intensity = (value - 1) * 0.5
        end
    })

    PostProcessGroup:AddSlider("TemperatureSlider", {
        Text = "色溫",
        Default = 1,
        Min = 0,
        Max = 2,
        Rounding = 1,
        Callback = function(value)
            if not lighting:FindFirstChild("ColorCorrection_Temperature") then
                local cc = Instance.new("ColorCorrectionEffect")
                cc.Name = "ColorCorrection_Temperature"
                cc.Parent = lighting
            end
            local coldColor = Color3.fromRGB(180, 220, 255)
            local warmColor = Color3.fromRGB(255, 220, 180)
            lighting.ColorCorrection_Temperature.TintColor = coldColor:Lerp(warmColor, value - 1)
        end
    })
end

-- ESP功能
local espEnabled = false
local espBoxes = {}

local ESPGroup = Tabs.Visuals:AddLeftGroupbox("ESP透視", "eye") do
    ESPGroup:AddToggle("PlayerESP", {
        Text = "玩家ESP",
        Default = false,
        Callback = function(value)
            espEnabled = value
            
            if value then
                local function createESP(player)
                    if player == game.Players.LocalPlayer then return end
                    
                    local character = player.Character
                    if not character then return end
                    
                    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                    if not humanoidRootPart then return end
                    
                    -- 創建紅色方框
                    local box = Instance.new("BoxHandleAdornment")
                    box.Name = "ESP_" .. player.Name
                    box.Adornee = humanoidRootPart
                    box.AlwaysOnTop = true
                    box.ZIndex = 10
                    box.Size = Vector3.new(4, 6, 2)
                    box.Color3 = Color3.fromRGB(255, 0, 0)
                    box.Transparency = 0.2
                    box.Parent = humanoidRootPart
                    
                    -- 創建名稱標籤
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = "ESP_Name_" .. player.Name
                    billboard.Adornee = humanoidRootPart
                    billboard.Size = UDim2.new(0, 200, 0, 50)
                    billboard.StudsOffset = Vector3.new(0, 3.5, 0)
                    billboard.AlwaysOnTop = true
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, 0, 1, 0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = player.Name
                    nameLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.TextSize = 14
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.Parent = billboard
                    
                    billboard.Parent = humanoidRootPart
                    
                    espBoxes[player] = {box = box, billboard = billboard}
                end
                
                -- 為現有玩家創建ESP
                for _, player in ipairs(game.Players:GetPlayers()) do
                    createESP(player)
                end
                
                -- 監聽新玩家
                game.Players.PlayerAdded:Connect(function(player)
                    player.CharacterAdded:Connect(function(character)
                        wait(1)
                        createESP(player)
                    end)
                end)
                
            else
                -- 禁用ESP
                for player, espObjects in pairs(espBoxes) do
                    if espObjects.box then espObjects.box:Destroy() end
                    if espObjects.billboard then espObjects.billboard:Destroy() end
                end
                espBoxes = {}
            end
        end
    })
end

-- 玩家功能
local MovementGroup = Tabs.Player:AddLeftGroupbox("移動功能", "move") do
    local speedEnabled = false
    
    MovementGroup:AddToggle("SpeedToggle", {
        Text = "速度修改",
        Default = false,
        Callback = function(value)
            speedEnabled = value
            if value then
                local character = game.Players.LocalPlayer.Character
                if character and character:FindFirstChild("Humanoid") then
                    character.Humanoid.WalkSpeed = 50
                end
            else
                local character = game.Players.LocalPlayer.Character
                if character and character:FindFirstChild("Humanoid") then
                    character.Humanoid.WalkSpeed = 16
                end
            end
        end
    })

    MovementGroup:AddSlider("WalkSpeed", {
        Text = "移動速度",
        Default = 50,
        Min = 16,
        Max = 100,
        Rounding = 1,
        Callback = function(value)
            if speedEnabled then
                local character = game.Players.LocalPlayer.Character
                if character and character:FindFirstChild("Humanoid") then
                    character.Humanoid.WalkSpeed = value
                end
            end
        end
    })

    MovementGroup:AddSlider("JumpPower", {
        Text = "跳躍高度",
        Default = 50,
        Min = 50,
        Max = 200,
        Rounding = 1,
        Callback = function(value)
            local character = game.Players.LocalPlayer.Character
            if character and character:FindFirstChild("Humanoid") then
                character.Humanoid.JumpPower = value
            end
        end
    })
end

local UtilityGroup = Tabs.Player:AddRightGroupbox("實用功能", "zap") do
    local noclipEnabled = false
    local noclipConnection = nil

    UtilityGroup:AddToggle("NoclipToggle", {
        Text = "穿牆模式",
        Default = false,
        Callback = function(value)
            noclipEnabled = value
            
            if value then
                noclipConnection = game:GetService("RunService").Stepped:Connect(function()
                    if not noclipEnabled then return end
                    
                    local character = game.Players.LocalPlayer.Character
                    if not character then return end
                    
                    for _, part in pairs(character:GetDescendants()) do
                        if part:IsA("BasePart") and part.CanCollide then
                            part.CanCollide = false
                        end
                    end
                end)
            else
                if noclipConnection then
                    noclipConnection:Disconnect()
                    noclipConnection = nil
                end
            end
        end
    })

    UtilityGroup:AddToggle("InfiniteJump", {
        Text = "無限跳躍",
        Default = false,
        Callback = function(value)
            if value then
                game:GetService("UserInputService").JumpRequest:Connect(function()
                    local character = game.Players.LocalPlayer.Character
                    if character and character:FindFirstChild("Humanoid") then
                        character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end)
            end
        end
    })
end

-- 無敵模式
local godModeEnabled = false
local godModeConnections = {}

local GodModeGroup = Tabs.Player:AddLeftGroupbox("無敵模式", "shield") do
    GodModeGroup:AddToggle("GodMode", {
        Text = "無敵模式",
        Default = false,
        Callback = function(value)
            godModeEnabled = value
            
            if value then
                local player = game.Players.LocalPlayer
                
                local function setupGodMode(character)
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.MaxHealth = math.huge
                        humanoid.Health = math.huge
                        
                        local healthConnection = humanoid.HealthChanged:Connect(function(newHealth)
                            if newHealth < math.huge then
                                humanoid.Health = math.huge
                            end
                        end)
                        
                        table.insert(godModeConnections, healthConnection)
                    end
                end
                
                if player.Character then
                    setupGodMode(player.Character)
                end
                
                local characterAddedConnection = player.CharacterAdded:Connect(function(character)
                    wait(1)
                    setupGodMode(character)
                end)
                
                table.insert(godModeConnections, characterAddedConnection)
                
                Library:Notify("無敵模式已啟用！", 5)
                
            else
                for _, connection in ipairs(godModeConnections) do
                    if connection and typeof(connection) == "RBXScriptConnection" then
                        connection:Disconnect()
                    end
                end
                godModeConnections = {}
                
                local player = game.Players.LocalPlayer
                if player.Character then
                    local humanoid = player.Character:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.MaxHealth = 100
                        humanoid.Health = 100
                    end
                end
                
                Library:Notify("無敵模式已禁用", 3)
            end
        end
    })
end

-- 自瞄功能
local aimbotEnabled = false
local aimbotConnection = nil

local AimbotSettingsGroup = Tabs.Aiming:AddLeftGroupbox("自瞄設定", "settings") do
    AimbotSettingsGroup:AddToggle("AimbotEnabled", {
        Text = "啟用自瞄",
        Default = false,
        Callback = function(value)
            aimbotEnabled = value
            
            if value then
                aimbotConnection = game:GetService("RunService").RenderStepped:Connect(function()
                    if not aimbotEnabled then return end
                    
                    local player = game.Players.LocalPlayer
                    local character = player.Character
                    local camera = workspace.CurrentCamera
                    
                    if not character or not camera then return end
                    
                    local rootPart = character:FindFirstChild("HumanoidRootPart")
                    if not rootPart then return
