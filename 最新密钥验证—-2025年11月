local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local Color3 = Color3
local UDim2 = UDim2
local Instance = Instance
local task = task
local Enum = Enum

-- 初始化 getgenv 环境
if not getgenv then
    getgenv = function() return getfenv and getfenv(0) or _G end
end

local AC_ENV = getgenv()
AC_ENV.LOLHUB_ANTICHEAT_LOADED = true
AC_ENV.LOLHUB_LOAD_TIME = os.time()

-- 注入器文件操作兼容
local readFunc, writeFunc, getPathFunc, isSupported

-- 检测并适配不同注入器
if type(syn) == "table" then
    readFunc = syn and (syn.readfile or readfile)
    writeFunc = syn and (syn.writefile or writefile)
    getPathFunc = function() 
        return (syn and syn.datapath and syn.datapath()) or "Synapse/Workspace"
    end
    isSupported = true
    print("✅ 适配 Synapse X 注入器")
elseif type(fluxus) == "table" then
    readFunc = readfile
    writeFunc = writefile
    getPathFunc = function() return "Fluxus/Scripts" end
    isSupported = true
    print("✅ 适配 Fluxus 注入器")
elseif type(KRNL_SAFE_CALL) == "function" or getexecutorname and string.find(string.lower(getexecutorname()), "krnl") then
    readFunc = readfile
    writeFunc = writefile
    getPathFunc = function() return "Krnl/Scripts" end
    isSupported = true
    print("✅ 适配 KRNL 注入器")
elseif type(identifyexecutor) == "function" then
    readFunc = readfile
    writeFunc = writefile
    getPathFunc = function() return "ScriptWare/Scripts" end
    isSupported = true
    print("✅ 适配 Script-Ware 或其他兼容注入器")
else
    isSupported = false
    warn("⚠️ 未知注入器，部分功能可能受限")
    readFunc = function(path) return nil end
    writeFunc = function(path, content) return false end
    getPathFunc = function() return "Unknown/Scripts" end
end

-- Krnl风格配色方案
local KRNL_COLORS = {
    BACKGROUND = Color3.fromRGB(25, 25, 35),
    PRIMARY = Color3.fromRGB(125, 75, 200),
    SECONDARY = Color3.fromRGB(90, 60, 150),
    ACCENT = Color3.fromRGB(150, 100, 220),
    TEXT = Color3.fromRGB(240, 240, 245),
    TEXT_SECONDARY = Color3.fromRGB(180, 180, 190),
    INPUT_BG = Color3.fromRGB(35, 35, 45),
    SUCCESS = Color3.fromRGB(100, 200, 100),
    ERROR = Color3.fromRGB(220, 100, 100),
    WARNING = Color3.fromRGB(255, 165, 0)
}

-- 密钥系统配置
local KEY_SYSTEM = {
    ENABLED = true,
    CORRECT_KEYS = {"LOL"},
    MAX_ATTEMPTS = 3,
    REMEMBER_DAYS = 30,
    DATA_FILE = "lolhub_key_data.json"
}

-- 反作弊系统配置
local ANTICHEAT = {
    ENABLED = true,
    CHECK_INTERVAL = 5,
    MAX_DETECTIONS = 3,
    DETECTION_TIMEOUT = 30
}

-- 反作弊检测结果存储
AC_ENV.LOLHUB_AC_DETECTIONS = 0
AC_ENV.LOLHUB_AC_LAST_CHECK = os.time()

-- ==================== 反作弊检测函数 ====================

-- 检测环境篡改
local function checkEnvironment()
    local detections = 0
    
    -- 检查getgenv是否被篡改
    if type(getgenv) ~= "function" then
        detections = detections + 1
        warn("⚠️ 反作弊: getgenv被篡改")
    end
    
    -- 检查全局环境
    if _G and _G.LOLHUB_ANTICHEAT_LOADED ~= true then
        detections = detections + 1
        warn("⚠️ 反作弊: 全局环境被篡改")
    end
    
    -- 检查常用作弊函数
    local suspiciousFunctions = {
        "hookfunction", "hookmetamethod", "setreadonly", 
        "setrawmetatable", "getrawmetatable", "checkcaller"
    }
    
    for _, funcName in ipairs(suspiciousFunctions) do
        if _G[funcName] and type(_G[funcName]) == "function" then
            detections = detections + 1
            warn("⚠️ 反作弊: 检测到可疑函数 " .. funcName)
        end
    end
    
    return detections
end

-- 检测脚本注入
local function checkScriptInjection()
    local detections = 0
    
    -- 检查CoreGui中的可疑脚本
    for _, obj in ipairs(CoreGui:GetDescendants()) do
        if obj:IsA("Script") or obj:IsA("LocalScript") then
            local name = obj.Name:lower()
            if string.find(name, "cheat") or string.find(name, "hack") or string.find(name, "exploit") then
                detections = detections + 1
                warn("⚠️ 反作弊: 检测到可疑脚本 " .. obj.Name)
            end
        end
    end
    
    -- 检查玩家背包中的脚本
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, obj in ipairs(backpack:GetDescendants()) do
            if obj:IsA("Script") or obj:IsA("LocalScript") then
                detections = detections + 1
                warn("⚠️ 反作弊: 检测到背包中的脚本 " .. obj.Name)
            end
        end
    end
    
    return detections
end

-- 检测调试器
local function checkDebugger()
    local detections = 0
    
    -- 尝试检测调试器
    local debugInfo = debug.getinfo(1)
    if debugInfo and debugInfo.source and string.find(debugInfo.source, "@") then
        -- 正常情况
    else
        detections = detections + 1
        warn("⚠️ 反作弊
